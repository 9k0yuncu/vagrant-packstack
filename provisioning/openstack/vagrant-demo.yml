---
  - name: Vagrant demo
    hosts: localhost
    become: false
    gather_facts: false
    tasks:
      - name: Create internal network
        os_network:
          name: internal_network
          state: present

      - name: Create internal subnet
        os_subnet:
          name: internal_subnet
          network_name: internal_network
          cidr: 192.168.0.0/24
          dns_nameservers:
           - 8.8.8.8
           - 8.8.4.4
          state: present

      - name: Create a router
        os_router:
          name: vagrant_router
          network: local_external_network
          interfaces:
            - internal_subnet

      - name: Add "Allow ping" rule to default security group
        os_security_group_rule:
          security_group: default
          protocol: icmp
          remote_ip_prefix: 0.0.0.0/0
          direction: ingress

      - name: Add "Allow ssh" rule to default security group
        os_security_group_rule:
          security_group: default
          protocol: tcp
          port_range_min: 22
          port_range_max: 22
          remote_ip_prefix: 0.0.0.0/0
          direction: ingress

      - name: Add your ssh public key
        os_keypair:
          state: present
          name: ansible_key
          public_key_file: "{{ lookup('env','HOME') }}/.ssh/id_rsa.pub"
