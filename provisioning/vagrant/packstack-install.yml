---
  - name: Upgrade the OS
    hosts: vagrant
    roles:
      - el-network
    vars:
      packstack_common_command: "packstack --default-password=admin \
        --install-hosts={{ openstack_api_ip }} \
        --service-workers=1 \
        --os-swift-install=n \
        --os-cinder-install=n \
        --os-heat-install=y \
        --os-neutron-metering-agent-install=n \
        --use-epel=n \
        --provision-demo=n \
        --os-neutron-ml2-type-drivers=vxlan,flat \
        "
    tasks:
      - name: Yum upgrade
        yum:
          name: '*'
          state: latest
          update_cache: yes

      - name: Update networking before reboot
        meta: flush_handlers

      - name: Disable firewalld
        systemd:
          name: firewalld
          state: stopped
          enabled: no

      - name: Install CentOS OpenStack repo
        yum:
          name: centos-release-openstack-ocata
          state: present

      - name: Install Packstack installer
        yum:
          name: openstack-packstack
          state: present

      - name: Run Packstack Installer - Please Wait
        command: "{{ packstack_common_command + packstack_guest_specific_args }}"
        async: 1200 # Possible this needs to be larger
        poll: 10

